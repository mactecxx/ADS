<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Wrapper</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* ALL STYLES EMBEDDED TO PREVENT 404 ERRORS */
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: sans-serif; }
        #main-frame { width: 100%; height: 100%; border: none; display: block; }
        
        /* Floating Button */
        .float-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #0891b2; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 9000; box-shadow: 0 10px 25px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .float-btn:hover { transform: scale(1.1); }
        
        /* Panel */
        #panel { position: fixed; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100vh; background: white; z-index: 9999; transition: right 0.4s ease; display: flex; flex-direction: column; box-shadow: -5px 0 30px rgba(0,0,0,0.2); }
        #panel.active { right: 0; }
        
        .p-header { background: #0f172a; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .p-body { flex: 1; overflow-y: auto; padding: 20px; position: relative; display: flex; flex-direction: column; }
        
        /* Input Styles */
        .inp { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 10px; outline: none; }
        .btn { width: 100%; padding: 12px; background: #0891b2; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .btn.sec { background: #64748b; }

        /* Chat Messages */
        #chat-ui { display: none; flex-direction: column; height: 100%; }
        .msgs { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-bottom: 20px; }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 10px; font-size: 14px; }
        .msg.me { align-self: flex-end; background: #0891b2; color: white; }
        .msg.agent { align-self: flex-start; background: #f1f5f9; border: 1px solid #e2e8f0; }

        /* Call Overlay */
        #call-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 100; }
        .timer { font-size: 32px; font-weight: bold; margin: 20px 0; font-variant-numeric: tabular-nums; }
        .ctrls { display: flex; gap: 20px; }
        .c-btn { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: background 0.2s; }
        .c-btn:hover { opacity: 0.9; }
        .bg-red { background: #ef4444; color: white; }
        .bg-gray { background: #475569; color: white; }
        .bg-blue { background: #3b82f6; color: white; }

        /* Missed Call Popup */
        #missed-popup { position: absolute; bottom: 0; left: 0; width: 100%; background: white; padding: 25px; border-top: 4px solid #ef4444; display: none; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); z-index: 200; }
        
        /* Pulse Animation */
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.5); } 100% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <iframe id="main-frame" src="home.html"></iframe>

    <div class="float-btn" onclick="togglePanel()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
    </div>

    <div id="panel">
        <div class="p-header">
            <span id="p-title" style="font-weight:bold;">Support Team</span>
            <button onclick="togglePanel()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <div class="p-body">
            
            <div id="login-form">
                <h3 class="text-xl font-bold text-slate-800 mb-2">Welcome</h3>
                <p class="text-slate-500 mb-6 text-sm">Please identify yourself to connect.</p>
                
                <input id="u-name" class="inp" placeholder="Full Name">
                <input id="u-email" class="inp" placeholder="Email Address (Required)">
                <input id="u-dob" class="inp" type="date" placeholder="Date of Birth">
                
                <div style="margin-top:20px; border-top:1px solid #f1f5f9; padding-top:20px;">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3">Start Session</p>
                    <button class="btn" onclick="identifyUser('chat')">üí¨ Start Text Chat</button>
                    <button class="btn sec" onclick="identifyUser('call')">üìû Start Voice Call</button>
                </div>
            </div>

            <div id="chat-ui">
                <div class="msgs" id="msg-box"></div>
                
                <div id="file-preview" style="display:none; padding:10px; background:#f1f5f9; border-top:1px solid #e2e8f0; font-size:12px;">
                    <span id="file-name"></span>
                    <button onclick="clearFile()" style="color:red; margin-left:10px; border:none; cursor:pointer;">(Remove)</button>
                </div>

                <div style="border-top:1px solid #e2e8f0; padding:10px; display:flex; gap:10px; align-items:center;">
                    <input type="file" id="file-input" hidden 
                        accept=".jpg, .jpeg, .png, .heic, .mp4, .mov, .pdf, .docx" 
                        onchange="handleFileSelect()">
                    
                    <button onclick="document.getElementById('file-input').click()" style="background:none; border:none; cursor:pointer; font-size:20px; color:#64748b;" title="Attach File">üìé</button>

                    <input id="chat-input" class="inp" style="margin:0;" placeholder="Type a message..." onkeypress="handleEnter(event)">
                    <button onclick="sendMsg()" style="background:#0891b2; color:white; border:none; padding:0 20px; border-radius:8px;">‚û§</button>
                </div>
                
                <div style="display:flex; justify-content:space-between; margin-top:10px; padding-top:10px; border-top:1px dashed #e2e8f0;">
                    <button onclick="startCallLogic()" class="text-xs font-bold text-blue-600 hover:underline">üìû Voice Call</button>
                    <button onclick="toggleScreenShare()" class="text-xs font-bold text-blue-600 hover:underline">üñ•Ô∏è Share Screen</button>
                </div>
            </div>

            <div id="call-overlay">
                <div style="width:12px; height:12px; background:#ef4444; border-radius:50%; margin-bottom:15px; animation:pulse 1s infinite;"></div>
                <h2 id="call-status" class="text-xl font-bold">Connecting...</h2>
                <div class="timer" id="call-timer">00:00</div>
                
                <div class="ctrls">
                    <button class="c-btn bg-gray" onclick="toggleMute()" title="Mute/Unmute">üé§</button>
                    <button class="c-btn bg-red" onclick="endCallLogic()" title="End Call">‚õî</button>
                </div>
            </div>

            <div id="missed-popup">
                <h4 class="text-lg font-bold text-red-600">Agents are busy</h4>
                <p class="text-sm text-slate-600 mb-3">We couldn't connect you. Please leave a message.</p>
                <textarea id="missed-msg" class="inp" placeholder="Type your request here..." style="min-height:80px;"></textarea>
                <button class="btn" onclick="submitMissedMsg()">Send Message</button>
                <button class="text-xs text-center w-full text-slate-400 underline" onclick="document.getElementById('missed-popup').style.display='none'">Close</button>
            </div>

        </div>
    </div>

    <script src="supabase-config.js"></script>

    <script>
        let currentUser = null;
        let currentChatId = null;
        let currentCallId = null;
        
        let pc = null;
        let localStream = null;
        let callTimerInterval = null;
        let callSeconds = 0;
        let missedCallTimeout = null;
        let selectedFile = null;

        function togglePanel() { document.getElementById('panel').classList.toggle('active'); }
        function handleEnter(e) { if(e.key === 'Enter') sendMsg(); }

        // --- 1. IDENTITY & SESSION (WITH DEBUGGING) ---
        async function identifyUser(actionType) {
            const name = document.getElementById('u-name').value;
            const email = document.getElementById('u-email').value;
            const dob = document.getElementById('u-dob').value;

            if(!email) return alert("Email is required.");
            
            // Visual Feedback
            const btn = event.target;
            const oldText = btn.innerText;
            btn.innerText = "Connecting...";
            btn.disabled = true;

            try {
                // Check if User Exists
                let { data: users, error: searchError } = await supabase.from('profiles').select('*').eq('email', email);
                if (searchError) throw new Error("Search Error: " + searchError.message);

                if (users && users.length > 0) {
                    currentUser = users[0];
                } else {
                    // Create New User
                    const { data: newUser, error: createError } = await supabase
                        .from('profiles')
                        .insert({ email, name, dob, role: 'client', status: 'online' })
                        .select().single();
                    if (createError) throw new Error("Create Profile Error: " + createError.message);
                    currentUser = newUser;
                }

                // Check/Create Chat
                let { data: chats, error: chatSearchError } = await supabase.from('chats').select('*').eq('user_id', currentUser.id).eq('status', 'active');
                if (chatSearchError) throw new Error("Chat Search Error: " + chatSearchError.message);

                if (chats && chats.length > 0) {
                    currentChatId = chats[0].id;
                } else {
                    const { data: newChat, error: chatCreateError } = await supabase
                        .from('chats')
                        .insert({ user_id: currentUser.id, status: 'queued' })
                        .select().single();
                    if (chatCreateError) throw new Error("Create Chat Error: " + chatCreateError.message);
                    currentChatId = newChat.id;
                }

                // UI Switch
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('chat-ui').style.display = 'flex';
                document.getElementById('p-title').innerText = `UID: ${currentUser.six_digit_id}`;

                loadChatHistory();
                subscribeToChat();

                if(actionType === 'call') startCallLogic();

            } catch (err) {
                alert("Error: " + err.message);
                btn.innerText = oldText;
                btn.disabled = false;
            }
        }

        // --- 2. MESSAGING & FILES ---
        function handleFileSelect() {
            const file = document.getElementById('file-input').files[0];
            if (file) {
                const ext = file.name.split('.').pop().toLowerCase();
                const validExts = ['jpg', 'jpeg', 'png', 'heic', 'mp4', 'mov', 'pdf', 'docx'];
                if (!validExts.includes(ext)) {
                    alert("Invalid file type.");
                    clearFile();
                    return;
                }
                selectedFile = file;
                document.getElementById('file-preview').style.display = 'block';
                document.getElementById('file-name').innerText = `üìé ${file.name}`;
            }
        }

        function clearFile() {
            document.getElementById('file-input').value = '';
            document.getElementById('file-preview').style.display = 'none';
            selectedFile = null;
        }

        function loadChatHistory() {
            supabase.from('messages').select('*').eq('chat_id', currentChatId).order('created_at')
                .then(res => { if(res.data) res.data.forEach(renderMsg); });
        }

        function subscribeToChat() {
            supabase.channel(`chat:${currentChatId}`)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${currentChatId}` }, payload => {
                    renderMsg(payload.new);
                })
                .subscribe();
        }

        function renderMsg(msg) {
            const box = document.getElementById('msg-box');
            const div = document.createElement('div');
            div.className = `msg ${msg.sender_id === currentUser.id ? 'me' : 'agent'}`;
            
            let content = msg.text ? `<div>${msg.text}</div>` : '';
            if (msg.file_url) {
                if (msg.file_type === 'image') content += `<a href="${msg.file_url}" target="_blank"><img src="${msg.file_url}" style="max-width:100%; border-radius:8px; margin-top:5px; max-height:200px;"></a>`;
                else if (msg.file_type === 'video') content += `<video controls src="${msg.file_url}" style="max-width:100%; border-radius:8px; margin-top:5px;"></video>`;
                else content += `<a href="${msg.file_url}" target="_blank" style="display:block; margin-top:5px; color:#2563eb; text-decoration:underline;">üìÑ View Document</a>`;
            }
            div.innerHTML = content;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        async function sendMsg() {
            const txt = document.getElementById('chat-input').value;
            if (!txt && !selectedFile) return;

            let fileUrl = null;
            let fileType = null;

            if (selectedFile) {
                const ext = selectedFile.name.split('.').pop();
                const fileName = `${Date.now()}.${ext}`;
                const { error } = await supabase.storage.from('chat_files').upload(fileName, selectedFile);
                if (error) return alert("Upload failed: " + error.message);
                
                const { data } = supabase.storage.from('chat_files').getPublicUrl(fileName);
                fileUrl = data.publicUrl;
                
                if (['jpg','jpeg','png','heic'].includes(ext)) fileType = 'image';
                else if (['mp4','mov'].includes(ext)) fileType = 'video';
                else fileType = 'doc';
            }

            await supabase.from('messages').insert({
                chat_id: currentChatId,
                sender_id: currentUser.id,
                text: txt,
                file_url: fileUrl,
                file_type: fileType
            });

            document.getElementById('chat-input').value = '';
            clearFile();
        }

        // --- 3. CALL LOGIC ---
        async function startCallLogic() {
            document.getElementById('call-overlay').style.display = 'flex';
            document.getElementById('call-status').innerText = "Calling...";
            
            missedCallTimeout = setTimeout(() => {
                if(document.getElementById('call-status').innerText !== "Connected") {
                    handleMissedCall();
                }
            }, 45000);

            pc = new RTCPeerConnection(rtcConfig);
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.onicecandidate = async (event) => {
                if(event.candidate && currentCallId) {
                    await supabase.from('ice_candidates').insert({
                        call_id: currentCallId,
                        candidate: event.candidate,
                        sender_role: 'caller'
                    });
                }
            };

            const remoteAudio = new Audio();
            pc.ontrack = (event) => {
                remoteAudio.srcObject = event.streams[0];
                remoteAudio.play();
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            const { data: callData } = await supabase.from('calls').insert({
                chat_id: currentChatId,
                caller_id: currentUser.id,
                status: 'calling',
                offer: offer
            }).select().single();
            
            currentCallId = callData.id;

            supabase.channel(`call:${currentCallId}`)
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'calls', filter: `id=eq.${currentCallId}` }, async payload => {
                    if (payload.new.status === 'connected' && payload.new.answer && !pc.currentRemoteDescription) {
                        clearTimeout(missedCallTimeout);
                        await pc.setRemoteDescription(new RTCSessionDescription(payload.new.answer));
                        document.getElementById('call-status').innerText = "Connected";
                        startCallTimer();
                        fetchIceCandidates(); 
                    }
                    if (payload.new.status === 'ended') endCallLogic(false); 
                })
                .subscribe();
        }

        async function fetchIceCandidates() {
            supabase.channel(`ice:${currentCallId}`)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'ice_candidates', filter: `call_id=eq.${currentCallId}` }, payload => {
                    if(payload.new.sender_role === 'callee') {
                        pc.addIceCandidate(new RTCIceCandidate(payload.new.candidate));
                    }
                })
                .subscribe();
        }

        function startCallTimer() {
            callSeconds = 0;
            callTimerInterval = setInterval(() => {
                callSeconds++;
                const mins = Math.floor(callSeconds / 60).toString().padStart(2, '0');
                const secs = (callSeconds % 60).toString().padStart(2, '0');
                document.getElementById('call-timer').innerText = `${mins}:${secs}`;
            }, 1000);
        }

        async function endCallLogic(notifyDB = true) {
            if(pc) pc.close();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            clearInterval(callTimerInterval);
            clearTimeout(missedCallTimeout);
            document.getElementById('call-overlay').style.display = 'none';
            document.getElementById('call-timer').innerText = "00:00";
            if(notifyDB && currentCallId) {
                await supabase.from('calls').update({ status: 'ended', end_time: new Date() }).eq('id', currentCallId);
            }
            currentCallId = null;
        }

        async function handleMissedCall() {
            endCallLogic(true); 
            if(currentCallId) {
                await supabase.from('calls').update({ status: 'missed' }).eq('id', currentCallId);
            }
            document.getElementById('missed-popup').style.display = 'block';
        }

        async function submitMissedMsg() {
            const msg = document.getElementById('missed-msg').value;
            await supabase.from('missed_calls').insert({
                user_id: currentUser.id,
                client_message: msg,
                status: 'new'
            });
            document.getElementById('missed-popup').style.display = 'none';
            alert("Message Sent.");
        }

        function toggleMute() {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            alert(track.enabled ? "Unmuted" : "Muted");
        }

        async function toggleScreenShare() {
            if(!pc) return alert("Start a call first.");
            try {
                const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const videoTrack = screenStream.getVideoTracks()[0];
                const sender = pc.getSenders().find(s => s.track.kind === 'video');
                if(sender) sender.replaceTrack(videoTrack);
                else pc.addTrack(videoTrack, localStream);
            } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>
