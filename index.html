<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVD Support Wrapper</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: sans-serif; }
        #main-frame { width: 100%; height: 100%; border: none; display: block; }
        
        /* Floating Button */
        .float-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #0891b2; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 9000; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        
        /* Panel */
        #panel { position: fixed; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100vh; background: white; z-index: 9999; transition: right 0.4s ease; display: flex; flex-direction: column; box-shadow: -5px 0 30px rgba(0,0,0,0.2); }
        #panel.active { right: 0; }
        
        .p-header { background: #0f172a; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .p-body { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        
        /* Form & Inputs */
        .inp { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 10px; outline: none; }
        .btn { width: 100%; padding: 12px; background: #0891b2; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .btn.sec { background: #64748b; }
        
        /* Chat Area */
        #chat-ui { display: none; flex-direction: column; height: 100%; }
        .msgs { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-bottom: 20px; }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 10px; font-size: 14px; }
        .msg.me { align-self: flex-end; background: #0891b2; color: white; }
        .msg.agent { align-self: flex-start; background: #f1f5f9; border: 1px solid #e2e8f0; }
        
        /* Call Modal */
        #call-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 100; }
        .timer { font-size: 32px; font-weight: bold; margin: 20px 0; }
        .ctrls { display: flex; gap: 20px; }
        .c-btn { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .bg-red { background: #ef4444; color: white; }
        .bg-gray { background: #475569; color: white; }
        .bg-blue { background: #3b82f6; color: white; }

        /* Missed Call Popup */
        #missed-popup { position: absolute; bottom: 0; left: 0; width: 100%; background: white; padding: 20px; border-top: 2px solid #ef4444; display: none; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <iframe id="main-frame" src="home.html"></iframe>

    <div class="float-btn" onclick="togglePanel()">ðŸ’¬</div>

    <div id="panel">
        <div class="p-header">
            <span id="p-title">Support Team</span>
            <button onclick="togglePanel()" style="background:none; border:none; color:white; font-size:24px;">&times;</button>
        </div>

        <div class="p-body">
            <div id="login-form">
                <h3 class="font-bold text-xl mb-4 text-slate-700">Get Help</h3>
                <input id="u-name" class="inp" placeholder="Full Name">
                <input id="u-email" class="inp" placeholder="Email Address (Required)">
                <input id="u-dob" class="inp" type="date" placeholder="Date of Birth">
                <div style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
                    <p class="text-sm text-slate-500 mb-2">How would you like to connect?</p>
                    <button class="btn" onclick="initSession('chat')">Start Chat</button>
                    <button class="btn sec" onclick="initSession('call')">Start Voice Call</button>
                </div>
            </div>

            <div id="chat-ui">
                <div class="msgs" id="msg-box"></div>
                <div style="border-top:1px solid #eee; padding-top:10px; display:flex; gap:10px;">
                    <input id="chat-input" class="inp" style="margin:0;" placeholder="Type message...">
                    <button onclick="sendMsg()" style="background:#0891b2; color:white; border:none; padding:0 20px; border-radius:8px;">âž¤</button>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <button onclick="startCall()" class="text-xs text-blue-600 underline">Start Call</button>
                    <button onclick="toggleScreenShare()" class="text-xs text-blue-600 underline">Share Screen</button>
                </div>
            </div>

            <div id="call-overlay">
                <div class="pulse-ring"></div>
                <h2 id="call-status">Calling...</h2>
                <div class="timer" id="call-timer">00:00</div>
                <div class="ctrls">
                    <button class="c-btn bg-gray" onclick="toggleMute()">ðŸŽ¤</button>
                    <button class="c-btn bg-red" onclick="endCall()">End</button>
                </div>
            </div>

            <div id="missed-popup">
                <h4 class="text-red-500 font-bold">Agents are busy.</h4>
                <p class="text-sm text-slate-600 mb-2">Please leave a message.</p>
                <textarea id="missed-msg" class="inp" placeholder="Your message..."></textarea>
                <button class="btn" onclick="submitMissedMsg()">Send Message</button>
                <button class="text-xs text-slate-400 underline w-full" onclick="initSession('call')">Try Calling Again</button>
            </div>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        let currentUser = null;
        let currentChatId = null;
        let pc = null;
        let localStream = null;
        let callTimerInt = null;
        let callSeconds = 0;
        let callTimeout = null; // 45s timer

        function togglePanel() { document.getElementById('panel').classList.toggle('active'); }

        // 1. IDENTITY & SESSION
        async function initSession(type) {
            const name = document.getElementById('u-name').value;
            const email = document.getElementById('u-email').value;
            const dob = document.getElementById('u-dob').value;

            if(!email) return alert("Email is required for identity.");

            // Check if user exists by Email
            const { data: existingUsers } = await supabase.from('profiles').select('*').eq('email', email);
            
            if(existingUsers && existingUsers.length > 0) {
                currentUser = existingUsers[0]; // Existing User
            } else {
                // New User
                const { data: newUser } = await supabase.from('profiles').insert({
                    email, name, dob, role: 'client'
                }).select().single();
                currentUser = newUser;
            }

            // Find or Create Chat
            const { data: chats } = await supabase.from('chats').select('*').eq('user_id', currentUser.id).eq('status', 'active');
            if(chats && chats.length > 0) {
                currentChatId = chats[0].id; // Resume active chat
            } else {
                const { data: newChat } = await supabase.from('chats').insert({
                    user_id: currentUser.id, status: 'queued'
                }).select().single();
                currentChatId = newChat.id;
            }

            // UI Switch
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('chat-ui').style.display = 'flex';
            document.getElementById('p-title').innerText = `ID: ${currentUser.six_digit_id}`;

            loadMessages();
            
            if(type === 'call') startCall();
        }

        // 2. CHAT
        function loadMessages() {
            supabase.channel('chat-room').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${currentChatId}` }, payload => {
                renderMsg(payload.new);
            }).subscribe();
            
            // Initial Load
            supabase.from('messages').select('*').eq('chat_id', currentChatId).order('created_at').then(res => {
                if(res.data) res.data.forEach(renderMsg);
            });
        }

        function renderMsg(msg) {
            const box = document.getElementById('msg-box');
            const div = document.createElement('div');
            div.className = `msg ${msg.sender_id === currentUser.id ? 'me' : 'agent'}`;
            div.innerText = msg.text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        async function sendMsg() {
            const txt = document.getElementById('chat-input').value;
            if(!txt) return;
            document.getElementById('chat-input').value = '';
            await supabase.from('messages').insert({ chat_id: currentChatId, sender_id: currentUser.id, text: txt });
        }

        // 3. CALL LOGIC
        async function startCall() {
            document.getElementById('call-overlay').style.display = 'flex';
            document.getElementById('call-status').innerText = "Calling...";
            
            // 45s Timeout Logic
            callTimeout = setTimeout(() => {
                if(document.getElementById('call-status').innerText !== 'Connected') {
                    handleMissedCall();
                }
            }, 45000); // 45 seconds

            pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] });
            
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

            pc.onicecandidate = async e => {
                if(e.candidate) await supabase.from('ice_candidates').insert({ chat_id: currentChatId, type: 'offer', candidate: e.candidate });
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            // Create Call Record
            await supabase.from('calls').upsert({ 
                chat_id: currentChatId, 
                caller_id: currentUser.id, 
                status: 'calling', 
                offer: offer,
                start_time: new Date()
            });

            // Listen for Answer
            supabase.channel('call-signaling').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'calls', filter: `chat_id=eq.${currentChatId}` }, async payload => {
                if(payload.new.status === 'connected' && !pc.currentRemoteDescription) {
                    clearTimeout(callTimeout); // Stop timeout
                    await pc.setRemoteDescription(new RTCSessionDescription(payload.new.answer));
                    document.getElementById('call-status').innerText = "Connected";
                    startTimer();
                }
                if(payload.new.status === 'ended') endCallLocal();
            }).subscribe();
        }

        function startTimer() {
            callSeconds = 0;
            callTimerInt = setInterval(() => {
                callSeconds++;
                const mins = Math.floor(callSeconds / 60).toString().padStart(2, '0');
                const secs = (callSeconds % 60).toString().padStart(2, '0');
                document.getElementById('call-timer').innerText = `${mins}:${secs}`;
            }, 1000);
        }

        async function endCall() {
            if(pc) pc.close();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            clearInterval(callTimerInt);
            clearTimeout(callTimeout);
            document.getElementById('call-overlay').style.display = 'none';
            await supabase.from('calls').update({ status: 'ended' }).eq('chat_id', currentChatId);
        }

        function endCallLocal() {
            if(pc) pc.close();
            clearInterval(callTimerInt);
            document.getElementById('call-overlay').style.display = 'none';
        }

        // 4. MISSED CALL HANDLING
        async function handleMissedCall() {
            endCallLocal(); // Close connection
            document.getElementById('missed-popup').style.display = 'block';
            await supabase.from('calls').update({ status: 'missed' }).eq('chat_id', currentChatId);
        }

        async function submitMissedMsg() {
            const msg = document.getElementById('missed-msg').value;
            await supabase.from('missed_calls').insert({
                user_id: currentUser.id,
                client_message: msg,
                status: 'new'
            });
            document.getElementById('missed-popup').style.display = 'none';
            alert("Message sent to team.");
        }

        // 5. SCREEN SHARE
        async function toggleScreenShare() {
            try {
                const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const videoTrack = screenStream.getVideoTracks()[0];
                const sender = pc.getSenders().find(s => s.track.kind === 'video');
                
                if(sender) sender.replaceTrack(videoTrack);
                else pc.addTrack(videoTrack, localStream);

                videoTrack.onended = () => {
                   // Logic to revert to camera if needed, or just stop
                };
            } catch(e) { console.error(e); }
        }
        
        function toggleMute() {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
        }
    </script>
</body>
</html>
