<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canada Visa Support</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- CORE LAYOUT --- */
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* The Iframe holds your actual website */
        #site-frame { 
            width: 100%; 
            height: 100%; 
            border: none; 
            display: block;
        }

        /* --- FLOATING BUTTON (Bottom Right) --- */
        .support-trigger-wrapper {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 15px;
            z-index: 9990;
        }

        /* The Options Panel (Call/Chat) */
        .support-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        .support-trigger-wrapper.active .support-options {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .btn-3d {
            background: linear-gradient(135deg, #0f172a, #334155);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            text-align: center;
            min-width: 130px;
        }
        .btn-3d:hover { transform: scale(1.05); }

        /* The Main Circular Button */
        .floating-support-btn {
            width: 65px;
            height: 65px;
            background: #0891b2; /* Teal Theme */
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 20px rgba(8, 145, 178, 0.4);
            cursor: pointer;
            transition: transform 0.3s;
        }
        .floating-support-btn:hover { transform: rotate(90deg); }

        /* --- SLIDING CHAT PANEL --- */
        #cvd-panel {
            position: fixed;
            top: 0;
            right: -450px; /* Hidden */
            width: 400px;
            max-width: 90%;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 30px rgba(0,0,0,0.15);
            z-index: 10000;
            transition: right 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            display: flex;
            flex-direction: column;
        }
        #cvd-panel.panel-open { right: 0; }

        /* HEADER */
        .panel-header {
            background: #0f172a;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .close-btn { cursor: pointer; font-size: 1.2rem; padding: 5px; }

        /* VIEWS */
        #auth-view, #chat-view { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        
        #auth-view { justify-content: center; gap: 15px; background: #f8fafc; }
        #chat-view { display: none; padding: 0; background: #fff; }

        /* INPUTS & BUTTONS */
        .cvd-input {
            padding: 14px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            width: 100%;
            box-sizing: border-box;
        }
        .cvd-input:focus { border-color: #0891b2; }

        .cvd-btn {
            padding: 14px;
            background: #0891b2;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            width: 100%;
        }
        .cvd-btn:hover { background: #0e7490; }

        /* MESSAGES AREA */
        .msgs-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f1f5f9;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .msg {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
        }
        .msg.me { 
            align-self: flex-end; 
            background: #0891b2; 
            color: white; 
            border-bottom-right-radius: 2px;
        }
        .msg.agent { 
            align-self: flex-start; 
            background: white; 
            color: #1e293b; 
            border: 1px solid #e2e8f0; 
            border-bottom-left-radius: 2px;
        }
        .timestamp { font-size: 10px; opacity: 0.7; margin-top: 5px; display: block; text-align: right; }
        .date-divider { text-align: center; font-size: 11px; color: #64748b; margin: 10px 0; font-weight: bold; background: #e2e8f0; padding: 4px 10px; border-radius: 20px; align-self: center; }

        /* FOOTER INPUT */
        .input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* --- CALL BANNER (Inside Chat) --- */
        #active-call-strip {
            display: none;
            background: #1e293b;
            padding: 10px;
            color: white;
            justify-content: space-between;
            align-items: center;
        }

        /* --- MODALS --- */
        #call-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #1e293b; color: white; padding: 30px; border-radius: 20px;
            text-align: center; width: 300px; display: none; z-index: 10002;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .call-controls { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .circle-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center;
        }
        .btn-end { background: #ef4444; color: white; }
        .btn-mute { background: #64748b; color: white; }
        .btn-screen { background: #0ea5e9; color: white; }

        /* File Preview Overlay */
        #file-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 10005; display: none;
            justify-content: center; align-items: center;
        }
        #file-content { max-width: 90%; max-height: 90%; }
        #file-content img, #file-content iframe { max-width: 100%; max-height: 100%; border:none; }
    </style>
</head>
<body>

    <iframe id="site-frame" src="home.html"></iframe>


    <div class="support-trigger-wrapper" id="support-trigger">
        <div class="support-options">
            <button class="btn-3d" onclick="openPanel('chat')">ðŸ’¬ Text Chat</button>
            <button class="btn-3d" onclick="openPanel('call')">ðŸ“ž Voice Call</button>
        </div>
        <div class="floating-support-btn" onclick="toggleMenu()">
            <svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
        </div>
    </div>


    <div id="cvd-panel">
        <div class="panel-header">
            <span>Support Team</span>
            <span class="close-btn" onclick="closePanel()">âœ•</span>
        </div>

        <div id="auth-view">
            <h3 style="text-align:center; color:#334155; margin:0;">Welcome</h3>
            <p style="text-align:center; font-size:13px; color:#64748b;">Please verify your identity to connect.</p>
            
            <input type="text" id="chat-name" class="cvd-input" placeholder="Full Name">
            <input type="email" id="chat-email" class="cvd-input" placeholder="Email Address">
            <input type="date" id="chat-dob" class="cvd-input">
            
            <button class="cvd-btn" onclick="handleChatLogin()">Start Conversation</button>
            <div id="login-status" style="text-align:center; font-size:12px; margin-top:10px;"></div>
        </div>

        <div id="chat-view">
            <div id="active-call-strip">
                <span id="call-timer" style="font-family:monospace;">00:00</span>
                <div style="display:flex; gap:10px;">
                    <button class="cvd-btn" style="padding:4px 8px; font-size:10px; background:#ef4444; width:auto;" onclick="endCall()">End</button>
                    <button class="cvd-btn" style="padding:4px 8px; font-size:10px; background:#64748b; width:auto;" onclick="toggleMute()">Mute</button>
                </div>
            </div>
            
            <div style="padding:10px; border-bottom:1px solid #e2e8f0; display:flex; gap:10px; justify-content:center; background:#f8fafc;">
                <button class="cvd-btn" style="flex:1; font-size:12px; background:#0f172a;" onclick="startCall()">ðŸ“ž Call</button>
                <button class="cvd-btn" style="flex:1; font-size:12px; background:#0ea5e9;" onclick="shareScreen()">ðŸ–¥ Screen</button>
            </div>

            <div class="msgs-area" id="msgs-area"></div>

            <div class="input-area">
                <input type="file" id="file-input" hidden onchange="uploadFile(this)">
                <button onclick="document.getElementById('file-input').click()" style="background:none; border:none; cursor:pointer; font-size:20px;">ðŸ“Ž</button>
                
                <input type="text" id="msg-input" placeholder="Type a message..." style="flex:1; border:none; outline:none; font-size:14px;">
                <button class="cvd-btn" onclick="sendMsg()" style="padding:8px 15px; width:auto;">âž¤</button>
            </div>
        </div>
    </div>


    <div id="call-modal">
        <h3 id="call-status-text" style="margin-bottom:20px;">Connecting...</h3>
        <div class="call-controls">
            <button class="circle-btn btn-mute" onclick="toggleMute()">ðŸŽ¤</button>
            <button class="circle-btn btn-screen" onclick="shareScreen()">ðŸ–¥</button>
            <button class="circle-btn btn-end" onclick="endCall()">âœ–</button>
        </div>
    </div>

    <div id="file-modal" onclick="this.style.display='none'">
        <div id="file-content"></div>
    </div>

    <script src="client-logic.js"></script>
    
    <script>
        // UI TOGGLES
        function toggleMenu() {
            document.getElementById('support-trigger').classList.toggle('active');
        }

        function openPanel(type) {
            document.getElementById('cvd-panel').classList.add('panel-open');
            document.getElementById('support-trigger').classList.remove('active');
            
            // If user is already logged in, they can jump straight to call
            if(type === 'call' && window.currentUser) {
                startCall();
            }
        }

        function closePanel() {
            document.getElementById('cvd-panel').classList.remove('panel-open');
        }
    </script>
    <script src="config.js"></script> <script src="client-logic.js"></script> </body>
</body>
</html>
